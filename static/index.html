<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Dermatology - Nhận diện bệnh da liễu</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #e8f5e8 0%, #f0f8ff 50%, #e6f3ff 100%);
            min-height: 100vh;
            color: #2c3e50;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: #2c3e50;
        }

        .header h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            color: #27ae60;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.8;
            margin-bottom: 15px;
        }

        .medical-disclaimer {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 15px;
            margin: 20px auto;
            max-width: 800px;
            font-size: 0.9rem;
            color: #856404;
            text-align: center;
        }

        .supported-diseases {
            background: #e8f5e8;
            border: 1px solid #27ae60;
            border-radius: 10px;
            padding: 15px;
            margin: 20px auto;
            max-width: 800px;
            font-size: 0.9rem;
            color: #2c3e50;
        }

        .supported-diseases h3 {
            color: #27ae60;
            margin-bottom: 10px;
            text-align: center;
        }

        .disease-list {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 10px;
        }

        .disease-item {
            padding: 5px 10px;
            background: white;
            border-radius: 5px;
            font-size: 0.85rem;
            border-left: 3px solid #27ae60;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 2px solid #e8f5e8;
        }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(0,0,0,0.15);
        }

        .card h2 {
            font-size: 1.8rem;
            margin-bottom: 20px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .icon {
            width: 35px;
            height: 35px;
            background: linear-gradient(135deg, #27ae60, #16a085);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .upload-area {
            border: 3px dashed #27ae60;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 20px;
            background: #f8fffe;
        }

        .upload-area:hover {
            border-color: #16a085;
            background: #e8f5e8;
        }

        .upload-area.dragover {
            border-color: #16a085;
            background: #e8f5e8;
        }

        .upload-icon {
            font-size: 3rem;
            color: #27ae60;
            margin-bottom: 15px;
        }

        .upload-text {
            color: #2c3e50;
            font-size: 1rem;
            margin-bottom: 10px;
        }

        .upload-subtext {
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        .btn {
            background: linear-gradient(135deg, #27ae60, #16a085);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px 5px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(39, 174, 96, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }

        .btn-secondary:hover {
            box-shadow: 0 8px 20px rgba(52, 152, 219, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .btn-danger:hover {
            box-shadow: 0 8px 20px rgba(231, 76, 60, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954);
        }

        .video-container {
            position: relative;
            margin-bottom: 20px;
        }

        #video, #canvas {
            width: 100%;
            max-width: 400px;
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            border: 2px solid #e8f5e8;
        }

        #canvas {
            display: none;
        }

        .results-section {
            grid-column: 1 / -1;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border: 2px solid #e8f5e8;
        }

        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            align-items: start;
        }

        .image-preview {
            text-align: center;
        }

        .preview-img {
            max-width: 100%;
            max-height: 400px;
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            margin-bottom: 15px;
            border: 2px solid #e8f5e8;
        }

        .results-list {
            background: #f8fffe;
            border-radius: 15px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e8f5e8;
        }

        .result-item {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            transition: transform 0.2s ease;
            border-left: 4px solid #27ae60;
        }

        .result-item:hover {
            transform: translateX(5px);
        }

        .result-item:last-child {
            margin-bottom: 0;
        }

        .disease-name {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 8px;
            line-height: 1.3;
        }

        .confidence-details {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-bottom: 10px;
        }

        .confidence-bar {
            background: #ecf0f1;
            height: 10px;
            border-radius: 5px;
            margin-top: 8px;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #27ae60, #16a085);
            border-radius: 5px;
            transition: width 0.5s ease;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #27ae60;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #fdedec;
            color: #c0392b;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            display: none;
            border: 1px solid #f1948a;
        }

        .success {
            background: #e8f5e8;
            color: #27ae60;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            border: 1px solid #27ae60;
        }

        .detection-status {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(39, 174, 96, 0.9);
            color: white;
            padding: 15px 25px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 10;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pulse-dot {
            width: 10px;
            height: 10px;
            background-color: #ffffff;
            border-radius: 50%;
            animation: pulse 1.5s infinite ease-in-out;
        }

        @keyframes pulse {
            0% {
                transform: scale(0.95);
                opacity: 0.7;
            }
            70% {
                transform: scale(1.1);
                opacity: 1;
            }
            100% {
                transform: scale(0.95);
                opacity: 0.7;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .results-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .card {
                padding: 20px;
            }

            .disease-list {
                grid-template-columns: 1fr;
            }
        }

        .hidden {
            display: none !important;
        }

        input[type="file"] {
            display: none;
        }

        .medical-icon {
            color: #27ae60;
        }

        .high-confidence {
            background: #e8f5e8;
            border-left-color: #27ae60;
        }

        .severity-warning {
            background: #ffeaa7;
            border-left-color: #f39c12;
        }

        .severity-danger {
            background: #fdedec;
            border-left-color: #e74c3c;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏥 AI Dermatology</h1>
            <p>Hệ thống nhận diện tổn thương da bằng trí tuệ nhân tạo</p>
        </div>

        <div class="medical-disclaimer">
            <strong>⚠️ LƯU Ý QUAN TRỌNG:</strong> Hệ thống này chỉ mang tính chất tham khảo và hỗ trợ chẩn đoán. 
            Không thay thế cho việc khám và tư vấn trực tiếp của bác sĩ da liễu. 
            Hãy luôn tham khảo ý kiến chuyên gia y tế cho chẩn đoán chính xác.
        </div>

        <div class="supported-diseases">
            <h3>📋 Các bệnh da liễu có thể nhận diện:</h3>
            <div class="disease-list">
                <div class="disease-item">🔬 Actinic Keratosis (Dày sừng quang hóa)</div>
                <div class="disease-item">🔬 Basal Cell Carcinoma (Ung thư biểu mô tế bào đáy)</div>
                <div class="disease-item">🔬 Benign Keratosis (Dày sừng lành tính)</div>
                <div class="disease-item">🔬 Dermatofibroma (U xơ da)</div>
                <div class="disease-item">🔬 Melanoma (U hắc tố ác tính)</div>
                <div class="disease-item">🔬 Melanocytic Nevi (Nốt ruồi sắc tố)</div>
                <div class="disease-item">🔬 Vascular Lesions (Tổn thương mạch máu)</div>
            </div>
        </div>

        <div class="main-content">
            <!-- Upload Section -->
            <div class="card">
                <h2>
                    <span class="icon">📤</span>
                    Tải lên hình ảnh
                </h2>
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">🖼️</div>
                    <p class="upload-text"><strong>Nhấp để tải lên</strong> hoặc kéo thả hình ảnh</p>
                    <p class="upload-subtext">Hỗ trợ JPG, PNG, GIF • Chụp rõ nét vùng da cần kiểm tra</p>
                </div>
                <input type="file" id="fileInput" accept="image/*">
                <button class="btn" onclick="document.getElementById('fileInput').click()">
                    📁 Chọn hình ảnh
                </button>
                <button class="btn btn-secondary" onclick="analyzeImage()" id="analyzeBtn" disabled>
                    🔬 Phân tích hình ảnh
                </button>
                <!-- Removed threshold slider section -->
            </div>

            <!-- Webcam Section -->
            <div class="card">
                <h2>
                    <span class="icon">📹</span>
                    Camera trực tiếp
                </h2>
                <div class="video-container">
                    <video id="video" autoplay muted></video>
                    <canvas id="canvas"></canvas>
                </div>
                <div id="detectionStatus" class="detection-status" style="display: none;">
                    <div class="status-indicator">
                        <div class="pulse-dot"></div>
                        <span>Đang phát hiện tổn thương da...</span>
                    </div>
                </div>
                <button class="btn" onclick="startCamera()" id="startCameraBtn">
                    📹 Bật camera
                </button>
                <button class="btn btn-secondary" onclick="capturePhoto()" id="captureBtn" disabled>
                    📸 Chụp ảnh
                </button>
                <button class="btn btn-secondary" onclick="toggleDetection()" id="toggleDetectionBtn" disabled>
                    🔍 Tự động phát hiện
                </button>
                <button class="btn btn-danger" onclick="stopCamera()" id="stopCameraBtn" disabled>
                    ⏹️ Tắt camera
                </button>
                <!-- Removed threshold slider section -->
            </div>
        </div>

        <!-- Results Section -->
        <div class="results-section" id="resultsSection" style="display: none;">
            <h2>
                <span class="icon">🎯</span>
                Kết quả phân tích
            </h2>
            <div class="results-grid">
                <div class="image-preview">
                    <img id="previewImage" class="preview-img" alt="Hình ảnh phân tích">
                </div>
                <div>
                    <div class="loading" id="loading">
                        <div class="spinner"></div>
                        <p>Đang phân tích hình ảnh bằng AI...</p>
                    </div>
                    <div class="results-list" id="resultsList"></div>
                    <div class="error" id="errorMessage"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentImage = null;
        let stream = null;
        let detectionThreshold = 0.65; // Fixed threshold, not customizable

        // Disease names mapping
        const DISEASE_NAMES = {
            'akiec': 'Actinic Keratosis (ung thư da dạng sừng hóa ánh sáng)',
            'bcc': 'Basal Cell Carcinoma (ung thư biểu mô tế bào đáy)',
            'bkl': 'Benign Keratosis-like Lesions (tổn thương dạng sừng lành tính)',
            'df': 'Dermatofibroma (u xơ da)',
            'mel': 'Melanoma (ung thư hắc tố)',
            'nv': 'Melanocytic Nevi (nốt ruồi sắc tố)',
            'vasc': 'Vascular Lesions (tổn thương mạch máu)'
        };

        // File upload handling
        const fileInput = document.getElementById('fileInput');
        const uploadArea = document.getElementById('uploadArea');
        const analyzeBtn = document.getElementById('analyzeBtn');

        fileInput.addEventListener('change', handleFileSelect);
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', handleDragOver);
        uploadArea.addEventListener('drop', handleDrop);

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                displayImage(file);
                analyzeBtn.disabled = false;
            }
        }

        function handleDragOver(event) {
            event.preventDefault();
            uploadArea.classList.add('dragover');
        }

        function handleDrop(event) {
            event.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = event.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                fileInput.files = event.dataTransfer.files;
                displayImage(file);
                analyzeBtn.disabled = false;
            }
        }

        function displayImage(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                currentImage = e.target.result;
                showResults();
                document.getElementById('previewImage').src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // Webcam handling
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const startCameraBtn = document.getElementById('startCameraBtn');
        const captureBtn = document.getElementById('captureBtn');
        const stopCameraBtn = document.getElementById('stopCameraBtn');
        
        let detectionInterval = null;
        let isDetecting = false;

        async function startCamera() {
                            try {
                    stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    video.srcObject = stream;
                    startCameraBtn.disabled = true;
                    captureBtn.disabled = false;
                    stopCameraBtn.disabled = false;
                    document.getElementById('toggleDetectionBtn').disabled = false;
                } catch (error) {
                    showError('Không thể truy cập camera hoặc camera không khả dụng');
                }
        }

        function startRealTimeDetection() {
            if (detectionInterval) {
                clearInterval(detectionInterval);
            }
            
            isDetecting = true;
            document.getElementById('detectionStatus').style.display = 'flex';
            
            detectionInterval = setInterval(async () => {
                if (!isDetecting) return;
                
                try {
                    // Capture current frame
                    const context = canvas.getContext('2d');
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    context.drawImage(video, 0, 0);
                    
                    const frameData = canvas.toDataURL('image/jpeg');
                    
                    // Send frame for detection
                    const response = await fetch('/api/object-detection/detect', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            image: frameData,
                            threshold: detectionThreshold
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.objects && result.objects.length > 0) {
                        // Check if any object meets the threshold
                        const highConfidenceObjects = result.objects.filter(obj => 
                            obj.confidence >= detectionThreshold
                        );
                        
                        if (highConfidenceObjects.length > 0) {
                            // High confidence object detected - capture the frame
                            console.log('High confidence object detected!', highConfidenceObjects);
                            currentImage = frameData;
                            showResults();
                            document.getElementById('previewImage').src = currentImage;
                            displayResults(highConfidenceObjects);
                            
                            // Stop real-time detection after capturing
                            stopRealTimeDetection();
                        }
                    }
                } catch (error) {
                    console.error('Detection error:', error);
                }
            }, 500); // Check every 500ms
        }

        function stopRealTimeDetection() {
            isDetecting = false;
            document.getElementById('detectionStatus').style.display = 'none';
            if (detectionInterval) {
                clearInterval(detectionInterval);
                detectionInterval = null;
            }
            
            // Reset button state
            const toggleBtn = document.getElementById('toggleDetectionBtn');
            toggleBtn.textContent = '🔍 Tự động phát hiện';
            toggleBtn.className = 'btn btn-secondary';
        }

        function capturePhoto() {
            const context = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0);
            
            currentImage = canvas.toDataURL('image/jpeg');
            showResults();
            document.getElementById('previewImage').src = currentImage;
            analyzeImage();
        }

        function stopCamera() {
            stopRealTimeDetection();
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                video.srcObject = null;
                startCameraBtn.disabled = false;
                captureBtn.disabled = true;
                stopCameraBtn.disabled = true;
                document.getElementById('toggleDetectionBtn').disabled = true;
                document.getElementById('toggleDetectionBtn').textContent = '🔍 Tự động phát hiện';
                document.getElementById('toggleDetectionBtn').className = 'btn btn-secondary';
            }
        }

        // Analysis functions
        async function analyzeImage() {
            if (!currentImage) return;

            showLoading();
            hideError();

            try {
                const response = await fetch('/api/object-detection/detect', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        image: currentImage,
                        threshold: detectionThreshold
                    })
                });

                const result = await response.json();
                hideLoading();

                if (result.error) {
                    showError(result.error);
                } else {
                    displayResults(result.objects);
                }
            } catch (error) {
                hideLoading();
                showError('Không thể phân tích hình ảnh. Vui lòng thử lại.');
                console.error('Analysis error:', error);
            }
        }

        function getSeverityLevel(classCode) {
            const severityMap = {
                'mel': 'danger',    // Melanoma - cao
                'bcc': 'warning',   // Basal Cell Carcinoma - trung bình
                'akiec': 'warning', // Actinic Keratosis - trung bình
                'vasc': 'normal',   // Vascular Lesions - thấp
                'df': 'normal',     // Dermatofibroma - thấp
                'bkl': 'normal',    // Benign Keratosis - thấp
                'nv': 'normal'      // Nevi - thấp
            };
            return severityMap[classCode] || 'normal';
        }

        function getSeverityText(severity) {
            const severityText = {
                'danger': '⚠️ Cần khám ngay',
                'warning': '⚡ Nên thăm khám',
                'normal': '✅ Theo dõi'
            };
            return severityText[severity] || '✅ Theo dõi';
        }

        function displayResults(objects) {
            const resultsList = document.getElementById('resultsList');
            resultsList.innerHTML = '';

            if (objects && objects.length > 0) {
                objects.forEach((obj, index) => {
                    const resultItem = document.createElement('div');
                    const isHighConfidence = obj.confidence >= detectionThreshold;
                    const severity = getSeverityLevel(obj.class);
                    const severityText = getSeverityText(severity);
                    
                    resultItem.className = 'result-item';
                    
                    // Add styling based on severity and confidence
                    if (isHighConfidence) {
                        if (severity === 'danger') {
                            resultItem.classList.add('severity-danger');
                        } else if (severity === 'warning') {
                            resultItem.classList.add('severity-warning');
                        } else {
                            resultItem.classList.add('high-confidence');
                        }
                    }
                    
                    const confidenceColor = isHighConfidence ? 
                        (severity === 'danger' ? '#e74c3c' : severity === 'warning' ? '#f39c12' : '#27ae60') : 
                        '#3498db';
                    
                    resultItem.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                            <div style="flex: 1;">
                                <div class="disease-name">${obj.description || DISEASE_NAMES[obj.class] || obj.class}</div>
                                <div style="font-size: 0.9rem; color: ${confidenceColor}; font-weight: bold; margin-top: 4px;">
                                    ${severityText}
                                </div>
                            </div>
                        </div>
                        <div class="confidence-details">
                            <strong>Mã bệnh:</strong> ${obj.class}
                            ${isHighConfidence ? ' <span style="color: ' + confidenceColor + '; font-weight: bold;"></span>' : ''}
                        </div>

                        ${obj.disease_probabilities ? `
                        <div style="margin-top: 15px;">
                            <h4 style="margin-bottom: 10px; color: #2c3e50; font-size: 0.9rem;">📊 Tỷ lệ các bệnh da liễu:</h4>
                            ${Object.entries(obj.disease_probabilities)
                                .sort(([,a], [,b]) => b.percentage - a.percentage)
                                .map(([diseaseCode, diseaseInfo]) => {
                                    const isTopPrediction = diseaseCode === obj.class;
                                    const barColor = isTopPrediction ? '#27ae60' : '#95a5a6';
                                    return `
                                        <div style="margin-bottom: 8px; padding: 6px; background: ${isTopPrediction ? '#e8f5e8' : '#f8f9fa'}; border-radius: 6px; border-left: 3px solid ${barColor};">
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 3px;">
                                                <span style="font-weight: ${isTopPrediction ? 'bold' : 'normal'}; color: #2c3e50; font-size: 0.8rem;">
                                                    ${isTopPrediction ? '🎯 ' : ''}${diseaseCode.toUpperCase()+": "}${DISEASE_NAMES[diseaseCode] || diseaseCode}
                                                </span>
                                                <span style="font-weight: bold; color: ${barColor}; font-size: 0.8rem;">
                                                    ${diseaseInfo.percentage}%
                                                </span>
                                            </div>
                                            <div style="background: #ecf0f1; height: 6px; border-radius: 3px; overflow: hidden;">
                                                <div style="width: ${diseaseInfo.percentage}%; height: 100%; background: ${barColor}; border-radius: 3px; transition: width 0.5s ease;"></div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                        </div>` : ''}
                        ${isHighConfidence && severity === 'danger' ? '<div style="margin-top: 8px; padding: 8px; background: #ffeaa7; border-radius: 5px; font-size: 0.85rem; color: #d63031;"><strong>Khuyến nghị:</strong> Nên thăm khám bác sĩ da liễu sớm nhất có thể.</div>' : ''}
                        ${isHighConfidence && severity === 'warning' ? '<div style="margin-top: 8px; padding: 8px; background: #dff0d8; border-radius: 5px; font-size: 0.85rem; color: #3c763d;"><strong>Khuyến nghị:</strong> Nên đặt lịch khám để được tư vấn thêm.</div>' : ''}
                    `;
                    resultsList.appendChild(resultItem);
                });
            } else {
                resultsList.innerHTML = '<div style="text-align: center; padding: 30px; color: #7f8c8d;"><div style="font-size: 2rem; margin-bottom: 10px;">🔍</div><p>Không phát hiện được tổn thương da</p><p style="font-size: 0.9rem; margin-top: 8px;">Hãy thử chụp ảnh rõ nét hơn hoặc điều chỉnh góc chụp</p></div>';
            }
        }

        function showResults() {
            document.getElementById('resultsSection').style.display = 'block';
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('resultsList').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('resultsList').style.display = 'block';
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }

        function toggleDetection() {
            const toggleBtn = document.getElementById('toggleDetectionBtn');
            if (isDetecting) {
                stopRealTimeDetection();
                toggleBtn.textContent = '🔍 Tự động phát hiện';
                toggleBtn.className = 'btn btn-secondary';
            } else {
                startRealTimeDetection();
                toggleBtn.textContent = '⏹️ Tắt tự động phát hiện';
                toggleBtn.className = 'btn btn-success';
            }
        }

        // Remove dragover class when dragging leaves the area
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
    </script>
</body>
</html>

